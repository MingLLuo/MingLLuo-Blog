---
layout: article
title: 对象引用、可变性、垃圾回收
tags: Python
permalink: /:title.html
---
- 变量不是盒子，变量是便利贴：把变量s分配给对象xxx
- `==` 比较两个对象的值(存储的数据)，`is`比较对象的标识(identity)
	- `is` 比 `==` 快，因为它不能被重载，Python可以直接比较两个整数ID
	- 一般`is`都用于和`None`做比较，但`==`也能有同样的效果，只是速度慢一些
- 浅拷贝复制最外层容器，覆盖的是与源容器中的引用，如果有可变项，则会有意想不到的问题，这个时候应该使用深拷贝
- Python唯一支持的参数传递模式是共享传参(call by sharing)，由此函数可能会修改作为参数传入的可变对象，而不改变其标识(it cannot altogether replace an object with another)

```python
"""
>>> bus1 = HauntedBus(['Alice', 'Bill'])
>>> bus1.passengers
['Alice', 'Bill']
>>> bus1.pick('Charlie')
>>> bus1.drop('Alice')
>>> bus1.passengers
['Bill', 'Charlie']
>>> bus2 = HauntedBus()
>>> bus2.pick('Carrie')
>>> bus2.passengers
['Carrie']
>>> bus3 = HauntedBus()
>>> bus3.passengers
['Carrie']
>>> bus3.pick('Dave')
>>> bus2.passengers
['Carrie', 'Dave']
>>> bus2.passengers is bus3.passengers
True
>>> bus1.passengers
['Bill', 'Charlie']

>>> dir(HauntedBus.__init__)  # doctest: +ELLIPSIS
['__annotations__', '__call__', ..., '__defaults__', ...]
>>> HauntedBus.__init__.__defaults__
(['Carrie', 'Dave'],)
>>> HauntedBus.__init__.__defaults__[0] is bus2.passengers
True
"""

class HauntedBus:
    """A bus model haunted by ghost passengers"""

    def __init__(self, passengers=[]): 
        self.passengers = passengers

    def pick(self, name):
        self.passengers.append(name)  

    def drop(self, name):
        self.passengers.remove(name)

```

- 创建对象时没有传入passengers，导致对象去引用类创建时产生的默认列表，变量成为参数默认值的别名
- del和垃圾回收：Python垃圾回收使用的主要算法是引用计数，当其归零时立即被销毁
	- 可以通过`weakref.finalize`注册回调函数，在销毁对象时调用
		- 传入这个函数的引用是弱引用，不会增加对象的引用计数
```python
>>> import weakref
>>> s1 = {1, 2, 3}
>>> s2 = s1
>>> def bye():
... print('...like tears in the rain.') 
...
>>> ender = weakref.finalize(s1, bye)
>>> ender.alive 
True
>>> del s1
>>> ender.alive 
True
>>> s2 = 'spam'
...like tears in the rain. 
>>> ender.alive 
False
```